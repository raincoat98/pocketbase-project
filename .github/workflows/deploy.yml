name: Deploy to Synology

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install sshpass & rsync
        run: sudo apt-get install -y sshpass rsync

      - name: Set up SSH config and keys
        env:
          SYNOLOGY_HOST: ${{ secrets.SYNOLOGY_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          RSYNC_PORT: ${{ secrets.RSYNC_PORT }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          cat <<EOF >> ~/.ssh/config
          Host ${{ secrets.SYNOLOGY_HOST }}
              HostName ${{ secrets.SYNOLOGY_HOST }}
              Port ${{ secrets.SSH_PORT }}
              StrictHostKeyChecking no
          EOF

      - name: Deploy to Synology (using rsync)
        env:
          SYNOLOGY_HOST: ${{ secrets.SYNOLOGY_HOST }}
          SYNOLOGY_USERNAME: ${{ secrets.SYNOLOGY_USERNAME }}
          SYNOLOGY_PASSWORD: ${{ secrets.SYNOLOGY_PASSWORD }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          RSYNC_PORT: ${{ secrets.RSYNC_PORT }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          # rsyncë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ íŒŒì¼ ë°°í¬
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            if rsync -avz --timeout=60 -e "sshpass -p $SYNOLOGY_PASSWORD ssh -p $RSYNC_PORT" \
              --exclude '.git' \
              --exclude 'node_modules' \
              --exclude '.env*' \
              --exclude 'pocketbase/pb_data*' \
              ./ $SYNOLOGY_USERNAME@$SYNOLOGY_HOST:$DEPLOY_PATH; then
              break
            fi
            echo "rsync ì‹œë„ $attempt ì‹¤íŒ¨. ì¬ì‹œë„ ì¤‘..."
            sleep 5
            attempt=$((attempt + 1))
          done

          if [ $attempt -gt $max_attempts ]; then
            echo "rsync ì‹¤íŒ¨: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"
            exit 1
          fi


          echo "ğŸ˜ í™˜ê²½ ì„¤ì • íŒŒì¼ ë°°í¬ ì‹œì‘..."

          # í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„± ë° ë°°í¬
          # FRONTEND_ENVì— VITE_API_URL=/api í¬í•¨ í•„ìš”
          pushd frontend && echo "${{ secrets.FRONTEND_ENV }}" > .env.production && popd

          # rsyncë¥¼ ì‚¬ìš©í•˜ì—¬ í™˜ê²½ ì„¤ì • íŒŒì¼ ë°°í¬ (ì¬ì‹œë„ ë¡œì§ ì¶”ê°€)
          for file in "frontend/.env.production:frontend/.env.production"; do
            src=${file%%:*}
            dest=${file#*:}
            dest_dir=$(dirname "$DEPLOY_PATH/$dest")
            attempt=1
            while [ $attempt -le $max_attempts ]; do
              if rsync -avz --timeout=60 -e "sshpass -p $SYNOLOGY_PASSWORD ssh -p $RSYNC_PORT" \
                "$src" "$SYNOLOGY_USERNAME@$SYNOLOGY_HOST:$DEPLOY_PATH/$dest"; then
                break
              fi
              echo "rsync ì‹œë„ $attempt ì‹¤íŒ¨. ì¬ì‹œë„ ì¤‘..."
              sleep 5
              attempt=$((attempt + 1))
            done
            if [ $attempt -gt $max_attempts ]; then
              echo "rsync ì‹¤íŒ¨: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"
              exit 1
            fi
          done

          echo "ëª¨ë“  íŒŒì¼ ë°°í¬ ì™„ë£Œ"

      - name: Run Docker Compose on Synology NAS
        env:
          SYNOLOGY_HOST: ${{ secrets.SYNOLOGY_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SYNOLOGY_USERNAME: ${{ secrets.SYNOLOGY_USERNAME }}
          SYNOLOGY_PASSWORD: ${{ secrets.SYNOLOGY_PASSWORD }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          shell: /usr/bin/bash -e {0}
        run: |
          max_attempts=5
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            if sshpass -p "${{ secrets.SYNOLOGY_PASSWORD }}" ssh -T -p $SSH_PORT ${{ secrets.SYNOLOGY_USERNAME }}@${{ secrets.SYNOLOGY_HOST }} << 'EOSSH'
              echo "ğŸ”„ PocketBase ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘..."

              # ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
              echo "${{ secrets.SYNOLOGY_PASSWORD }}" | sudo -S bash -c '
              cd "${{ secrets.DEPLOY_PATH }}"

              # Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
              if ! command -v docker &> /dev/null; then
                echo "ğŸš€ Dockerê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
                
                # Synology íŒ¨í‚¤ì§€ ì„¼í„°ë¥¼ í†µí•´ Docker ì„¤ì¹˜
                synopkg install Docker || { echo "âŒ Docker ì„¤ì¹˜ ì‹¤íŒ¨"; exit 1; }

                echo "âœ… Docker ì„¤ì¹˜ ì™„ë£Œ"
              else
                echo "âœ… Dockerê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
              fi

              # Docker ì„œë¹„ìŠ¤ ì‹œì‘
              echo "ğŸš€ Docker ì„œë¹„ìŠ¤ ì‹œì‘ ë° í™œì„±í™” ì¤‘..."
              systemctl start docker
              systemctl enable docker
              echo "âœ… Docker ì„œë¹„ìŠ¤ ì‹¤í–‰ ì™„ë£Œ"

              # Docker Compose ì„¤ì¹˜ í™•ì¸
              if ! command -v docker-compose &> /dev/null; then
                echo "ğŸš€ Docker Composeê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
                curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
                  -o /usr/local/bin/docker-compose
                chmod +x /usr/local/bin/docker-compose
                echo "âœ… Docker Compose ì„¤ì¹˜ ì™„ë£Œ"
              fi

              # docker-compose.yml íŒŒì¼ ì¡´ì¬ í™•ì¸
              if [ ! -f "docker-compose.prod.yml" ]; then
                echo "âŒ ì˜¤ë¥˜: docker-compose.prod.yml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
                ls -al
                exit 1
              fi

              chmod +x deploy.sh && ./deploy.sh
              
              echo "âœ… PocketBase ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸"
              docker-compose -f docker-compose.prod.yml ps || true
              
              echo "ğŸ“œ PocketBase ìµœê·¼ ë¡œê·¸ ì¶œë ¥"
              docker-compose -f docker-compose.prod.yml logs --tail=50 pocketbase || true
              '
          EOSSH
            then
              break
            fi
            echo "âš ï¸ SSH ì—°ê²° ì‹œë„ $attempt ì‹¤íŒ¨. ì¬ì‹œë„ ì¤‘..."
            sleep 5
            attempt=$((attempt + 1))
          done

          if [ $attempt -gt $max_attempts ]; then
            echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"
            exit 1
          fi
